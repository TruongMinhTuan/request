/**
*
* RecipeDetails
*
*/

import React from 'react';
import Helmet from 'react-helmet';
import classnames from 'classnames/bind';
import { FormattedMessage } from 'react-intl';
import { IconCartHappy } from 'components/Icons';
import TagOos from 'components/TagOos';
import {
  DebugHelper,
  Container,
  Row,
  Col,
  CoverPhoto,
  Input,
  Button,
} from 'components/Basement';
import EntityAuthor from 'components/EntityAuthor';
import EntityDescription from 'components/EntityDescription';
import Permalink from 'components/Permalink';
import Fblike from 'components/Fblike';
import {
  isProductAvailable,
} from 'app/utils';
import messages from './messages';
import styles from './styles.styl';

const cx = classnames.bind(styles);
const debug = new DebugHelper('components/RecipeDetails');

const Ingredient = (props) => {
  function toggleCheckbox (productId, quantity) {
    if (productId) {
      let indexOfProduct = -1;
      productsToAdd.forEach((product, index) => {
        if (product.productId === productId) {
          indexOfProduct = index;
        }
      });
      if (indexOfProduct === -1) {
        productsToAdd.push({ productId, quantity });
      } else {
        productsToAdd.splice(indexOfProduct, 1);
      }
    }
    checkEmpty();
  }

  const { ingredient, locale, productsToAdd, cart, checkEmpty, data } = props;
  const {
    displayQuantity,
    text,
    text_vn: textVn,
    product = {},
    quantity,
  } = ingredient;

  const {
    id: productId,
    name: productName,
    availableQuantity,
    published,
  } = product;
  const isAvailable = isProductAvailable(availableQuantity);
  const outOfStock = !isAvailable || !published;
  const ingredientName = locale === 'vi'
    ? (textVn || text)
    : text;
  const thumbnail = product['thumbnail@2x'];
  const thumbnailUrl = thumbnail && thumbnail[0] && thumbnail[0].url;
  const isAdded = productsToAdd.map(products => products.productId).includes(productId);
  console.log("isAdder  "+isAdded +"data"+ data)
  return (
    <tr className={styles.ingredientsItem}>
      <td>
        { productId && cart.has(productId) &&
          <span className={styles.ingredientStatus}>
            <IconCartHappy height={20} width={20} />
          </span>
        }
        { productId && !cart.has(productId) && !outOfStock && !data &&
          <Input
            name={productId}
            type="checkbox"
            defaultChecked={isAdded}
            className="inline"
            onChange={() => toggleCheckbox(productId, quantity)}
          />
        }
        { productId && !cart.has(productId) && !outOfStock && data &&
          <Input
            name={productId}
            type="checkbox"
            defaultChecked
            className="inline"
            onChange={() => toggleCheckbox(productId, quantity)}
          />
        }
      </td>
      <td className={styles.ingredientQuantity}>
        {displayQuantity || '+'}
      </td>
      <td
        className={styles.ingredientName}
        colSpan={!productId ? '2' : '1'}
      >
        { ingredientName }
        <br />
        {productId && outOfStock &&
        <TagOos className={styles.outOfStockTag} />
        }
      </td>
      {productId && (
        <td>
          <Permalink
            deeplink={`product::${productId}`}
            name={name}
            className={styles.ingredientProduct}
          >
            { thumbnailUrl &&
              <CoverPhoto
                height={146}
                src={thumbnailUrl}
                alt={productName}
                ratio="3_2"
              />
            }
          </Permalink>
        </td>
      )}
    </tr>
  );
};

class RecipeDetails extends React.Component {
  constructor (props) {
    super(props);
    this.checkEmpty = this.checkEmpty.bind(this);
    this.setNewNumber = this.setNewNumber.bind(this)
    this.state = {
      isEmptyCheck: false,
      data: false,
      button:false,
    };
  }

  componentWillMount () {
    const {
      ingredients,
      productsToAdd,
      cart,
    } = this.props;
    function isOutOfStock (availableQuantity, published) {
      return !isProductAvailable(availableQuantity) || !published;
    }
    ingredients.forEach((ingredient) => {
      if (ingredient.product && !cart.has(ingredient.product.id) && ingredient.product && !isOutOfStock(ingredient.product.availableQuantity, ingredient.product.published)) {
        productsToAdd.push({
          productId: ingredient.product.id,
          quantity: ingredient.quantity,
        });
      }
    });
  }
  checkEmpty () {
    const {
      productsToAdd,
    } = this.props;
    
    let isEmpty = false;
    if (productsToAdd.length === 0) { isEmpty = true; }
    this.setState({ isEmptyCheck: isEmpty });
  }
  setNewNumber() {
    const {
      ingredients,
      productsToAdd,
      cart,
      addProductsToCart,
    } = this.props;
    function isOutOfStock (availableQuantity, published) {
      return !isProductAvailable(availableQuantity) || !published;
    }
    productsToAdd.length=0;
        ingredients.forEach((ingredient) => {
          if (ingredient.product && !cart.has(ingredient.product.id) && ingredient.product && !isOutOfStock(ingredient.product.availableQuantity, ingredient.product.published)) {
            productsToAdd.push({
              productId: ingredient.product.id,
              quantity: ingredient.quantity,
            });
          }
        });
        console.log("this is test"+productsToAdd.length)
      this.setState({data: !this.state.data , isEmptyCheck  :false})

   }
  render () {
    debug('render');
    const classes = cx({
      recipeDetails: true,
    });
    const {
    name,
    description = '',
    images,
    author,
    ingredients,
    preparations,
    locale,
    // serve,
    addProductsToCart,
    productsToAdd,
    cart,
    checkEmpty,
  } = this.props;
  
    const photoUrl = images && images[0] && images[0].url;

    debug('ingredientName', ingredients);

    const metaTitle = `${name}`;
    let metaKeywords = ingredients
    .map(ingredient => `${ingredient.text},${ingredient.text_vn}`);

    metaKeywords.push('công thức nấu ăn');
    metaKeywords.push('cooking');
    metaKeywords.push('recipe');
    metaKeywords = metaKeywords.join(',');

    const metaDescription = `Công Thức Nấu Ăn (Recipe): ${name} (${author}) - ${description}`;
    function isOutOfStock (availableQuantity, published) {
      return !isProductAvailable(availableQuantity) || !published;
    }
    function isFullAdd () {
      if (productsToAdd.length === 0) { return true; }
      const availableProduct = [];
      ingredients.forEach((ingredient) => {
        if (ingredient.product && !isOutOfStock(ingredient.product.availableQuantity, ingredient.product.published)) {
          availableProduct.push({
            productId: ingredient.product.id,
          });
        }
      });
      return !availableProduct.map(Product => cart.has(Product.productId)).includes(false);
    }
    function disableCheckBoxAll () {
      let temp=0;
      const availableProduct = [];
      let check=false
      
      ingredients.forEach((ingredient) => {
        if(ingredient.product && cart.has(ingredient.product.id))
        temp++;
        if (ingredient.product && !isOutOfStock(ingredient.product.availableQuantity, ingredient.product.published)) {
          availableProduct.push({
            productId: ingredient.product.id,
          });
        }
      });
      
    
      console.log(availableProduct.length-temp-productsToAdd.length)
      if(availableProduct.length-temp-productsToAdd.length  > 0)
      return true
      
      return check
    }
   

    return (
      <div className={classes}>

        <Helmet title={metaTitle}>
          <meta name="description" content={metaDescription} />
          <meta name="keywords" content={metaKeywords} />
          <meta name="og:title" content={`chopp.vn | ${metaTitle}`} />
          <meta name="og:description" content={metaDescription} />
          { photoUrl &&
            <meta name="og:image" content={photoUrl} />
          }
        </Helmet>

        <Container centered>
          <Row>
            <Col desktop={12}>
              <h4 className={styles.heading}>{name}</h4>
            </Col>
          </Row>

          <Row className={styles.socialActions}>
            <Col desktop={12}>
              <Fblike />
            </Col>
          </Row>

          <Row className={styles.introduction}>
            <Col
              desktop={4}
              tablet={6}
              mobile={12}
              className={styles.preface}
            >
              {
                author && <EntityAuthor text={`—${author}`} />
              }
              {
                description && (
                  <EntityDescription>
                    <br />
                    {description}
                  </EntityDescription>
                )
              }
            </Col>

            { photoUrl && (
              <Col
                desktop={6}
                tablet={6}
                mobile={12}
              >
                <CoverPhoto
                  src={photoUrl}
                  alt={name}
                  className={styles.photo}
                  ratio="3_2"
                />
              </Col>
            )}
          </Row>

          <Row className={styles.details}>
            <Col
              desktop={4}
              tablet={6}
              mobile={12}
              className={styles.ingredients}
            >
              { ingredients.length && (
                <div className={styles.headerWrapper}>
                  <h5 className={styles.subHeading}>
                    <FormattedMessage {...messages.ingredientHeading} />
                  </h5>
                  <Button
                    cast="success"
                    className={styles.addAllToCartButton}
                    size="small"
                    disabled={this.state.isEmptyCheck || isFullAdd()}
                    onClick={() => { addProductsToCart(productsToAdd); productsToAdd.length = 0; }}
                  >
                    <FormattedMessage {...messages.addToCart} />
                  </Button>
                </div>

              )}
                       
         
              { disableCheckBoxAll() && (
                <div><Input
                  name="checkAll"
                  type="checkbox"
                  //onChange={() => toggleCheckbox()}
                  onChange={this.setNewNumber}
                />Check All</div>
               )}
              <table className={styles.ingredientsList}>
                <tbody>
                  { ingredients
                      .map((ingredient, i) => (
                        <Ingredient
                          ingredient={ingredient}
                          key={i}
                          locale={locale}
                          productsToAdd={productsToAdd}
                          cart={cart}
                          checkEmpty={this.checkEmpty}
                          data={this.state.data}
                        />
                      ))
                  }
                </tbody>
              </table>
            </Col>

            <Col
              desktop={8}
              tablet={6}
              mobile={12}
              className={styles.preparations}
            >
              <div className={styles.headerWrapper}>
                { preparations.length > 0 && (
                  <h5 className={styles.subHeading}>
                    <FormattedMessage {...messages.instructionHeading} />
                  </h5>
                )}
              </div>
              <ul className={styles.preparationsList}>
                { preparations.map((step, i) => (
                  <li className={styles.preparationsItem} key={i}>
                    {
                      locale === 'vi'
                        ? (step.text_vn || step.text)
                        : step.text
                    }
                  </li>
                ))}
              </ul>

              <div className={styles.socialComments}>
                <div
                  className="fb-comments"
                  data-numposts="5"
                  data-width="100%"
                ></div>
              </div>
            </Col>
          </Row>

        </Container>
      </div>
    );
  }
}

export default RecipeDetails;
